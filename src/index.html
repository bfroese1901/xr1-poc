<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <title>XR File Upload</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>

    <script src="https://cxppusa1formui01cdnsa01-endpoint.azureedge.net/usa/FormCapture/FormCapture.bundle.js"></script>

    <script>
      // NOTE: for reference see https://go.microsoft.com/fwlink/?linkid=2250770

      /*
      # Ask user if they want to upload the Kennametal template file, or type in their text: Form field should be revealed
      # If file upload field has a file uploaded, then Option 1 should be disabled and clear out the value. Otherwise it can be written in
      ## Supporting Text labels, required fields, etc.
      
      # What happens to the API call if there is just Text? what if the file is uploaded, and vice versa? How does the PA flow need to change?

      
      */

      function generateGUID() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }

      if ($("#emailInput").val().toLowerCase().match("@kennametal.com").index > 0 || $("#emailInput").val().toLowerCase().match("@widia.com").index > 0) {
            document.getElementById("#emailInput").value = null;
            alert("Please do not enter Kennametal & Widia email address in this field.");
      }
      

      let formMapGuid = generateGUID();

      d365mktformcapture
        .waitForElement("#xrForm") // example: "#form1" as a selector for form with id="form1"
        .then((form) => {
          $("#fmguid").val(formMapGuid);

          const mappings = [
            {
              FormFieldName: "firstName",
              DataverseFieldName: "firstname",
            },
            {
              FormFieldName: "emailAddress",
              DataverseFieldName: "emailaddress1",
            },
            {
              FormFieldName: "companyName",
              DataverseFieldName: "ttec_companyname",
            },
            {
              FormFieldName: "telephone",
              DataverseFieldName: "elogic_telephone1_body",
            },
            {
              FormFieldName: "city",
              DataverseFieldName: "address1_city",
            },
            {
              FormFieldName: "postalCode",
              DataverseFieldName: "address1_postalcode",
            },
            {
              FormFieldName: "lastName",
              DataverseFieldName: "lastname",
            },
            {
              FormFieldName: "jobTitle",
              DataverseFieldName: "jobtitle",
            },
            {
              FormFieldName: "accountNumber",
              DataverseFieldName: "ttec_accountnumber",
            },
            {
              FormFieldName: "preferredLanguage",
              DataverseFieldName: "mspp_userpreferredlcid",
              DataverseFieldValue: [
                { FormValue: "english", DataverseValue: "1033" }, // English
              ],
            },
            {
              FormFieldName: "country",
              DataverseFieldName: "elogic_country",
              DataverseFieldValue: [
                { FormValue: "usa", DataverseValue: "851750228" }, // United States
              ],
            },
            {
              FormFieldName: "option1",
              DataverseFieldName: "ttec_option1_name",
            },
            {
              FormFieldName: "option2",
              DataverseFieldName: "ttec_option2",
            },
            {
              FormFieldName: "additionalInfo",
              DataverseFieldName: "ttec_additionalinformation",
            },
            {
              FormFieldName: "consentField",
              DataverseFieldName:
                "msdynmkt_purposeid;channels;optinwhenchecked",
              DataverseFieldValue:
                "2b61575d-9c12-ef11-9f89-6045bda713f9;Email;true",
            },
            {
              FormFieldName: "formmappingguid",
              DataverseFieldName: "ttec_cijformmappingguid",
            },
          ];

          form.addEventListener(
            "submit",
            (e) => {
              e.preventDefault();

              const serializedForm = d365mktformcapture.serializeForm(
                form,
                mappings
              );

              const payload = serializedForm.SerializedForm.build();

              const captureConfig = {
                FormId: "e3e3e399-2022-ef11-840b-6045bdebaa39",
                FormApiUrl:
                  "https://public-usa.mkt.dynamics.com/api/v1.0/orgs/16931aff-d26b-4b88-b323-fd941f691e25/landingpageforms",
              };

              d365mktformcapture
                .submitForm(captureConfig, payload)
                .then((e) => {
                  //If User has uploaded a file using Option 2 field, then an HTTP POST call is made to Power Automate
                  let fileInput = document.getElementById("fileInput");

                  if (fileInput.files.length > 0) {
                    var form = new FormData();
                    form.append("fileContent", fileInput.files[0]);
                    form.append("fileName", fileInput.files[0].name);
                    form.append("fmguid", formMapGuid);
                    var settings = {
                      url: "https://prod-162.westus.logic.azure.com:443/workflows/47c1cd9187524ff6b7f24e08e01bab75/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Xi1hntO4LHwysxCJ6ngzGCOxp6V0fazwktYHjuyuIrA",
                      method: "POST",
                      timeout: 0,
                      processData: false,
                      mimeType: "multipart/form-data",
                      contentType: false,
                      data: form,
                      headers:{
                        "MarketingCaseToken":"4cb14be8-417f-405a-adc1-26c0eb7c24b0"
                      }
                    };

                    $.ajax(settings).done(function (response) {
                      console.log(response);
                    });
                  }
                })
                .catch((e) => {
                  // error handling
                  console.log(e);
                });
            },
            true
          );
        });
    </script>
  </head>

  <body>
    <main>
      <h1>XR File Upload</h1>
    </main>

    <form action="" id="xrForm">
      <p>First Name: <input type="text" name="firstName" /></p>
      <p>Last Name: <input type="text" name="lastName" /></p>
      <p>Job Title: <input type="text" name="jobTitle" /></p>
      <p>Email: <input id="emailInput" type="text" name="emailAddress" /></p>
      <p>Company Name: <input type="text" name="companyName" /></p>
      <p>Account Number: <input type="text" name="accountNumber" /></p>
      <p>Phone: <input type="text" name="telephone" /></p>
      <p>City: <input type="text" name="city" /></p>
      <p>Postal Code: <input type="text" name="postalCode" /></p>
      <p>
        Country: <input type="radio" name="country" value="usa" /><label
          >USA</label
        >
      </p>
      <p>
        Preferred Language:<input
          type="radio"
          name="preferredLanguage"
          value="english"
        /><label>English</label>
      </p>
      <p>Option 1: File Submission <input type="text" name="option1" /></p>

      <p style="display:none;">
        Option 2: Cross Reference Data (Less than 10 items)
        <input type="text" name="option2" />
      </p>

      <p>
        To provide the details of your request, please download and use our
        <a
          href="https://kennametal.com/content/dam/kennametal/kennametal/ConversionGuide/form-template/Format_Kennametal_Preferred.xlsx"
          >template</a
        >
      </p>

      <label for="excelFile">Option 2 Upload Excel File:</label>
      <input
        id="fileInput"
        type="file"
        class="form-control"
        accept=".xlsx, .xls"
      />

      <p>Additional Information: <input type="text" name="additionalInfo" /></p>

      <p>Consent: <input type="checkbox" name="consentField" /></p>

      <input id="fmguid" type="hidden" name="formmappingguid" />

      <button type="submit">Submit form</button>
    </form>
  </body>
</html>
