<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <title>XR File Upload</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>

    <script src="https://cxppusa1formui01cdnsa01-endpoint.azureedge.net/usa/FormCapture/FormCapture.bundle.js"></script>

    <script>
      // NOTE: for reference see https://go.microsoft.com/fwlink/?linkid=2250770

      function generateGUID() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }
      
      const fileInput = document.getElementById('fileInput');

      let formMapGuid = generateGUID();

      d365mktformcapture
        .waitForElement("#xrForm") // example: "#form1" as a selector for form with id="form1"
        .then((form) => {
          $("#fmguid").val(formMapGuid);

          const mappings = [
            {
              FormFieldName: "firstName",
              DataverseFieldName: "firstname",
            },
            {
              FormFieldName: "emailAddress",
              DataverseFieldName: "emailaddress1",
            },
            {
              FormFieldName: "companyName",
              DataverseFieldName: "ttec_companyname",
            },
            {
              FormFieldName: "telephone",
              DataverseFieldName: "elogic_telephone1_body",
            },
            {
              FormFieldName: "city",
              DataverseFieldName: "address1_city",
            },
            {
              FormFieldName: "postalCode",
              DataverseFieldName: "address1_postalcode",
            },
            {
              FormFieldName: "lastName",
              DataverseFieldName: "lastname",
            },
            {
              FormFieldName: "jobTitle",
              DataverseFieldName: "jobtitle",
            },
            {
              FormFieldName: "accountNumber",
              DataverseFieldName: "ttec_accountnumber",
            },
            {
              FormFieldName: "preferredLanguage",
              DataverseFieldName: "mspp_userpreferredlcid",
              DataverseFieldValue: [
                { FormValue: "english", DataverseValue: "1033" }, // English
              ],
            },
            {
              FormFieldName: "country",
              DataverseFieldName: "elogic_country",
              DataverseFieldValue: [
                { FormValue: "usa", DataverseValue: "851750228" }, // United States
              ],
            },
            {
              FormFieldName: "option1",
              DataverseFieldName: "ttec_option1_name",
            },
            {
              FormFieldName: "option2",
              DataverseFieldName: "ttec_option2",
            },
            {
              FormFieldName: "additionalInfo",
              DataverseFieldName: "ttec_additionalinformation",
            },
            {
              FormFieldName: "consentField",
              DataverseFieldName:
                "msdynmkt_purposeid;channels;optinwhenchecked",
              DataverseFieldValue:
                "2b61575d-9c12-ef11-9f89-6045bda713f9;Email;true",
            },
            {
              FormFieldName: "formmappingguid",
              DataverseFieldName: "ttec_cijformmappingguid",
            },
          ];

          form.addEventListener(
            "submit",
            (e) => {
              e.preventDefault();

              const serializedForm = d365mktformcapture.serializeForm(
                form,
                mappings
              );

              const payload = serializedForm.SerializedForm.build();

              const captureConfig = {
                FormId: "e3e3e399-2022-ef11-840b-6045bdebaa39",
                FormApiUrl:
                  "https://public-usa.mkt.dynamics.com/api/v1.0/orgs/16931aff-d26b-4b88-b323-fd941f691e25/landingpageforms",
              };

              d365mktformcapture
                .submitForm(captureConfig, payload)
                .then((e) => {
                 
                  // var settings = {
                  //   url: "https://prod-130.westus.logic.azure.com:443/workflows/61b9d83e497f4905bf4dd22a7bcff6c6/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=h6laXcncIa1zYUmYZEWMZcNUtjOSLrE46-2rQ489g0w",
                  //   method: "POST",
                  //   timeout: 0,
                  //   headers: {
                  //     "Content-Type": "application/json",
                  //   },
                  //   data: JSON.stringify({
                  //     data: formMapGuid,
                  //   }),
                  // };

                  // $.ajax(settings).done(function (response) {
                  //   console.log(response);
                  // });
                  
                  debugger;

                  if (fileInput.files.length > 0) {
                    var form = new FormData();
                    form.append("fileContent", fileInput.files[0]);
                    form.append("fileName", fileInput.files[0].name);
                    form.append("fmguid", formMapGuid);
                    var settings = {
                      "url": "https://prod-162.westus.logic.azure.com:443/workflows/47c1cd9187524ff6b7f24e08e01bab75/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Xi1hntO4LHwysxCJ6ngzGCOxp6V0fazwktYHjuyuIrA",
                      "method": "POST",
                      "timeout": 0,
                      "processData": false,
                      "mimeType": "multipart/form-data",
                      "contentType": false,
                      "data": form
                    };

                    $.ajax(settings).done(function (response) {
                      console.log(response);
                    });
                  };

                })
                .catch((e) => {
                  // error handling
                  console.log(e);
                  //debugger;
                });
            },
            true
          );
        });
    </script>

   
  </head>

  <body>
    <main>
      <h1>XR File Upload</h1>
    </main>

    <form action="" id="xrForm">
      <p>First Name: <input type="text" name="firstName" /></p>
      <p>Last Name: <input type="text" name="lastName" /></p>
      <p>Job Title: <input type="text" name="jobTitle" /></p>
      <p>Email: <input type="text" name="emailAddress" /></p>
      <p>Company Name: <input type="text" name="companyName" /></p>
      <p>Account Number: <input type="text" name="accountNumber" /></p>
      <p>Phone: <input type="text" name="telephone" /></p>
      <p>City: <input type="text" name="city" /></p>
      <p>Postal Code: <input type="text" name="postalCode" /></p>
      <p>Country: <input type="radio" name="country" value="usa" /></p>
      <p>Preferred Language:<input type="radio" name="preferredLanguage" value="english" /></p>
      <p>Option 1: <input type="text" name="option1" /></p>
      <p>Option 2: <input type="text" name="option2" /></p>

      <p>To provide the details of your request, please download and use our <a href="https://kennametal.com/content/dam/kennametal/kennametal/ConversionGuide/form-template/Format_Kennametal_Preferred.xlsx">template</a></p>

      <label for="excelFile">Upload Excel File:</label>
      <input
        id="fileInput"
        type="file"
        class="form-control"
        accept=".xlsx, .xls"
      />

      <p>Additional Information: <input type="text" name="additionalInfo" /></p>

      <p>Consent: <input type="checkbox" name="consentField" /></p>

      <input id="fmguid" type="hidden" name="formmappingguid" />

      <button type="submit">Submit form</button>
    </form>

    <!-- <form id="fileUploadForm">
      
      <label for="email">Email:</label>
      <input id="emailInput" type="text" class="form-control" required />
      <button id="btnUploadFile" type="button" class="btn btn-primary">
        Add Document
      </button>
    </form> -->

  </body>
</html>
